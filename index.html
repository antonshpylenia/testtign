<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Visibility & Focus Test</title>
<style>
  body {
    font-family: monospace;
    background: #111;
    color: #eee;
    padding: 20px;
  }
  #toolbar {
    margin-bottom: 10px;
  }
  button {
    background: #333;
    color: #fff;
    border: 1px solid #666;
    padding: 6px 12px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
  }
  button:hover {
    background: #444;
  }
  #log {
    border: 1px solid #444;
    padding: 10px;
    height: 60vh;
    overflow-y: auto;
    background: #000;
  }
  .event { margin-bottom: 6px; }
  .hidden { color: #f77; }
  .focus { color: #7f7; }
  .blur { color: #ff7; }
  .mouse { color: #7af; }
  .idle { color: #aaa; }
</style>
</head>
<body>
  <h2>ðŸ§  Visibility & Focus Event Logger</h2>
  <div id="toolbar">
    <button id="clearLogs">ðŸ§¹ Clear Logs</button>
  </div>
  <div id="log"></div>

  <script>
    const logBox = document.getElementById('log');
    const clearBtn = document.getElementById('clearLogs');

    function log(msg, cls = '') {
      const div = document.createElement('div');
      div.className = `event ${cls}`;
      div.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
      logBox.appendChild(div);
      logBox.scrollTop = logBox.scrollHeight;
      console.log(msg);
    }

    // Clear logs
    clearBtn.addEventListener('click', () => {
      logBox.innerHTML = '';
      log('ðŸ§¹ Logs cleared');
    });

    // --- Visibility & focus ---
    document.addEventListener('visibilitychange', () => {
      if (document.hidden) {
        log('document.hidden = true (tab not visible)', 'hidden');
      } else {
        log('document.hidden = false (tab visible again)', 'focus');
        resetIdleTimer();
      }
    });

    window.addEventListener('focus', () => {
      log('window focus', 'focus');
      resetIdleTimer();
    });

    window.addEventListener('blur', () => log('window blur', 'blur'));

    // --- Mouse leave/enter window ---
    window.addEventListener('mouseout', e => {
      if (!e.relatedTarget && !e.toElement) {
        log('mouse left window â†’ possible tab switch or close', 'mouse');
      }
    });

    window.addEventListener('mouseover', e => {
      if (!e.relatedTarget && !e.fromElement) {
        log('mouse reentered window', 'mouse');
        resetIdleTimer();
      }
    });

    // --- Before unload ---
    window.addEventListener('beforeunload', e => {
      log('âš ï¸ beforeunload event fired (tab close/refresh attempt)', 'hidden');
      // e.preventDefault(); e.returnValue = ''; // Uncomment for dialog (deprecated)
    });

    // --- Idle detection ---
    let idleTimer = null;
    const IDLE_TIMEOUT = 10_000; // 10 seconds
    const activityEvents = ['mousemove', 'keydown', 'click', 'scroll', 'touchstart'];

    function resetIdleTimer() {
      clearTimeout(idleTimer);
      if (!document.hidden && document.hasFocus()) {
        idleTimer = setTimeout(() => {
          log('ðŸ• idle timeout reached (no activity for 10s)', 'idle');
        }, IDLE_TIMEOUT);
      }
    }

    activityEvents.forEach(ev =>
      window.addEventListener(ev, resetIdleTimer, { passive: true })
    );

    // initialize
    log('Logger initialized. Waiting for events...');
    resetIdleTimer();
  </script>
</body>
</html>
